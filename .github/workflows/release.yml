name: Build tagged releases

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            artifact_suffix: macos
          - os: windows-latest
            artifact_suffix: windows
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Capture Maven coordinates
        id: coordinates
        run: |
          ARTIFACT_ID=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.artifactId)
          VERSION=$(mvn -q -DforceStdout help:evaluate -Dexpression=project.version)
          echo "ARTIFACT_ID=$ARTIFACT_ID" >> "$GITHUB_ENV"
          echo "MAVEN_VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Resolve app version from tag
        run: echo "APP_VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"

      - name: Build application JAR
        run: mvn -DskipTests package

      - name: Create custom runtime
        run: |
          mkdir -p build
          "$JAVA_HOME/bin/jlink" \
            --add-modules ALL-MODULE-PATH \
            --module-path "$JAVA_HOME/jmods" \
            --strip-debug --no-header-files --no-man-pages \
            --output build/runtime

      - name: Package app image (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          "$JAVA_HOME/bin/jpackage" \
            --name FanucCommentTool \
            --app-version "$APP_VERSION" \
            --type app-image \
            --input target \
            --main-jar "$ARTIFACT_ID-$MAVEN_VERSION.jar" \
            --runtime-image build/runtime \
            --vendor "BYD Tools" \
            --icon icons/macIcon.icns \
            --java-options "-Dserver.port=8910" \
            --mac-package-identifier com.byd.tools.fanuccommenttool \
            --dest build/dist

      - name: Package app image (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          "$JAVA_HOME/bin/jpackage" \
            --name FanucCommentTool \
            --app-version "$APP_VERSION" \
            --type app-image \
            --input target \
            --main-jar "$ARTIFACT_ID-$MAVEN_VERSION.jar" \
            --runtime-image build/runtime \
            --vendor "BYD Tools" \
            --icon icons/windowsIcon.ico \
            --java-options "-Dserver.port=8910" \
            --dest build/dist

      - name: Archive macOS image
        if: matrix.os == 'macos-latest'
        run: |
          mkdir -p build/packages
          ditto -c -k --sequesterRsrc --keepParent "build/dist/FanucCommentTool.app" "build/packages/FanucCommentTool-macos-${APP_VERSION}.zip"
      
      - name: Archive Windows image
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path build\packages -Force | Out-Null
          $archive = "build/packages/FanucCommentTool-windows-$env:APP_VERSION.zip"
          if (Test-Path $archive) { Remove-Item $archive }
          Compress-Archive -Path build/dist/FanucCommentTool -DestinationPath $archive

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: FanucCommentTool-${{ matrix.artifact_suffix }}
          path: build/packages/*.zip
          if-no-files-found: error

  release:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Prepare app version
        run: echo "APP_VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_ENV"

      - name: Download packaged artifacts
        uses: actions/download-artifact@v4
        with:
          path: build/releases

      - name: Publish GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: FanucCommentTool ${{ env.APP_VERSION }}
          draft: false
          prerelease: false
          files: |
            build/releases/**/FanucCommentTool-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}